<html>
<title>MMT BattleShips</title>

<style type="text/css">
  #game-area {
    width: 300px;
    height: 300px;
    background-color: #ccc;
    opacity: 0;
  }
</style>

<script src="/socket.io/socket.io.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

<script type="text/javascript">

var $j = jQuery.noConflict();

var myPlayerName = 'Blub';
var myPlayState = 'waiting';
var selectedPlayerIP;
var interval;
var time;

$j(document).ready(function(){

  var socket = io.connect('http://localhost');
  
  socket.on('mmtBattleShips', function (data) {
    //console.log(data);

    var dataLength = data.length;
    var importantMessage = data.slice(9, dataLength)
    var foundColon = importantMessage.search(':');

    var findIP = importantMessage.search('#');
    var playerIP = importantMessage.slice(findIP + 1, dataLength);

    // check, if player plays mmtships :)
    var checkGame = data.slice(0, 8);
    if ( checkGame != 'mmtships' )
      return;
    
    var playerName;
    var playerMessage;

    // if there is an message behind the player's name, work with it!
    if (foundColon != -1) {
      playerName = importantMessage.slice(0, foundColon);
      playerMessage = importantMessage.slice(foundColon + 1, findIP);

      // if getting a new play request
      if (playerMessage == 'startgame') {
        if (confirm(playerName + ' moechte mit dir spielen!')) {
          selectedPlayerIP = playerIP;
          socket.emit('playRequest', 'mmtships:accepted', selectedPlayerIP);
          interval = setInterval(function() {
            socket.emit('playRequest', 'mmtships:alive', selectedPlayerIP);
          }, 2000);
          startGame();
        } else {
          socket.emit('playRequest', 'mmtships:declined', playerIP);
        }
      }
    // if sent a play request and got an answer
    } else {
      playerMessage = importantMessage.slice(0, findIP);

      if (playerMessage == 'declined') {
        clearTimeout(time);
        alert ('Spielanfrage wurde abgelehnt!');
      } else if (playerMessage == 'accepted') {
        clearTimeout(time);
        interval = setInterval(function() {
          socket.emit('playRequest', 'mmtships:alive', selectedPlayerIP);
        }, 2000);
        startGame();
      } else {
        playerName = importantMessage.slice(0, findIP);
        writePlayerList(playerName, playerIP);
      }
    }
  });

  $j('#button').click(function(event) {
    socket.emit('serverSocket', 'mmtships:' + myPlayerName);
  });

  $j('.players').live('click', function(event){
    var selectedPlayer = $j(this).text();
    var msg = 'mmtships:' + myPlayerName + ':startgame';
    var findeOtherIP = selectedPlayer.search(':');
    var otherIP = selectedPlayer.slice(findeOtherIP + 1, selectedPlayer.length);
    socket.emit('playRequest', msg, otherIP);

    time = setTimeout(function() { noAnswer() }, 30000);
  });

  function noAnswer() {
    alert ('Keine Antwort!');
    myPlayState = 'waiting';
  }

  function writePlayerList(name, ip) {
    //if (name != myPlayerName) {
      $j('#player-online').append('<p class="players">' + name + ':' + ip + '</p>');

      // don't forget: answer to request of other players with current playing state
      var msg = 'mmtships:' + myPlayerName + ':' + myPlayState;
      socket.emit('playRequest', msg, ip);
    //}
  }

  function startGame() {
    myPlayState = 'playing';
    $j('#game-area').css({
      'opacity' : '1'
    });
    // ToDo: Spiel starten!
  }

});
</script>
</head>

<body>

<button type="submit" id="button">Spielanfrage</button>
<div id="player-online"></div>
<div id="game-area">
  Battle Ships Game Area
</div>

</body>
</html>